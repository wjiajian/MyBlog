name: Deploy to Aliyun

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # è¯·å°†ä¸‹é¢çš„ /path/to/your/project æ›¿æ¢ä¸ºæ‚¨æœåŠ¡å™¨ä¸Šçš„å®é™…é¡¹ç›®è·¯å¾„
            # ä¾‹å¦‚: cd /www/wwwroot/myblog
            cd /home/MyBlog

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "Starting deployment..."
            git pull origin main

            # å®‰è£…ä¾èµ–ï¼ˆé˜²æ­¢æœ‰æ–°ä¾èµ–åŠ å…¥ï¼‰
            echo "Installing dependencies..."
            npm install

            # æ„å»ºæœåŠ¡ç«¯ä»£ç  (å¿…é¡»ï¼å› ä¸º build åªæ„å»ºå‰ç«¯)
            echo "Building server..."
            npm run build:server

            # æ„å»ºå‰ç«¯é¡¹ç›®
            echo "Building project..."
            npm run build

            # é‡å¯ PM2 æœåŠ¡ (å…ˆåˆ é™¤å†å¯åŠ¨ï¼Œé¿å…é‡å¤è¿›ç¨‹)
            echo "ğŸ”„ Reloading PM2..."
            pm2 delete myblog || true
            pm2 start npm --name "myblog" -- run serve

            echo "Deployment complete!"
